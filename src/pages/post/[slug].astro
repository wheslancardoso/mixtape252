---
import { PortableText } from "@portabletext/react";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { sanityClient, urlFor } from "../../lib/sanity";

export async function getStaticPaths() {
  const posts = await sanityClient.fetch(`*[_type == "post"]{
    ...,
    slug
  }`);
  return posts.map((post: any) => ({
    params: { slug: post.slug.current },
    props: { post },
  }));
}

interface Props {
  post: any;
}

const { post } = Astro.props;

// Gera URL da imagem OG dinâmica
const ogImage = `/api/og?slug=${post.slug.current}`;

// Prepara description (excerpt ou fallback)
let description = post.excerpt || "Digital Zine & Creative Collective";
if (!post.excerpt && post.body && Array.isArray(post.body)) {
  // Tenta extrair texto do primeiro bloco de texto do PortableText
  const firstBlock = post.body.find(
    (block: any) => block._type === "block" && block.children,
  );
  if (firstBlock && firstBlock.children && firstBlock.children[0]) {
    const text = firstBlock.children[0].text || "";
    description = text.substring(0, 160) + (text.length > 160 ? "..." : "");
  }
}

const source = Astro.url.searchParams.get("source");
---

<BaseLayout
  title={post.title}
  description={description}
  image={ogImage}
  type="article"
>
  <article class="min-h-screen bg-white text-black">
    <header class="border-b-4 border-black pb-8 mb-12">
      <div class="container mx-auto px-4 pt-12">
        <div class="flex flex-col gap-4">
          <span
            class="font-mono text-sm bg-black text-white inline-block w-fit px-2 py-1 uppercase"
          >
            {new Date(post.publishedAt).toLocaleDateString("pt-BR")}
          </span>

          <h1
            class="text-5xl md:text-8xl font-black uppercase leading-[0.9] tracking-tighter break-words"
          >
            {post.title}
          </h1>
        </div>
      </div>

      {
        post.mainImage && (
          <div class="mt-8 border-y-4 border-black overflow-hidden">
            <img
              src={urlFor(post.mainImage).width(1200).url()}
              alt={post.title}
              class="w-full h-[60vh] object-cover grayscale hover:grayscale-0 transition-all duration-500"
            />
          </div>
        )
      }
    </header>

    <div class="container mx-auto px-4 max-w-3xl pb-20">
      <div
        class="prose prose-lg md:prose-2xl max-w-none font-mono text-black leading-relaxed marker:text-black prose-headings:font-headline prose-headings:uppercase prose-headings:font-black prose-p:text-black prose-p:text-justify prose-img:border-4 prose-img:border-black prose-a:text-safety-orange prose-a:no-underline hover:prose-a:underline"
      >
        <PortableText value={post.body} />
      </div>

      <div class="mt-16 border-t-4 border-black pt-8">
        <a
          id="back-link"
          href={source ? `/drop/${source}` : "/"}
          class="inline-block px-8 py-3 bg-black text-white font-mono font-bold uppercase hover:bg-red-600 transition-colors shadow-[4px_4px_0px_0px_rgba(0,0,0,0.3)]"
        >
          {source ? "← VOLTAR PARA A EDIÇÃO" : "← VOLTAR PARA O CAOS"}
        </a>
      </div>
    </div>
  </article>

  <script>
    // Client-side fallback for static export
    const params = new URLSearchParams(window.location.search);
    const source = params.get("source");
    const backLink = document.getElementById("back-link");

    if (source && backLink) {
      backLink.setAttribute("href", `/drop/${source}`);
      backLink.innerText = "← VOLTAR PARA A EDIÇÃO";
    }
  </script>
</BaseLayout>
