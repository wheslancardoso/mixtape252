---
import { PortableText } from "@portabletext/react";
import BaseLayout from "../../layouts/BaseLayout.astro";
import ChannelBadge from "../../components/ChannelBadge.astro";
import { sanityWriteClient, urlFor } from "../../lib/sanity";
import Blockquote from "../../components/Blockquote";
import {
  H2,
  H3,
  BulletList,
  NumberList,
  SanityImage,
} from "../../components/PortableTextComponents";

export async function getStaticPaths() {
  // FIX: Filtra posts com slug definido e exclui rascunhos explicitamente
  const posts =
    await sanityWriteClient.fetch(`*[_type == "post" && defined(slug.current) && !(_id in path("drafts.**"))]{ 
    slug,
    channel 
  }`);

  return posts.map((post: any) => ({
    params: { slug: post.slug.current },
  }));
}

const { slug } = Astro.params;
const post = await sanityWriteClient.fetch(
  `*[_type == "post" && slug.current == $slug][0]`,
  { slug },
);

if (!post) return Astro.redirect("/404");

// 1. Definição dos Temas (Mantendo estética Zine)
function getTheme(channel: string) {
  switch (channel) {
    case "system_log": // Tech / Code
      return {
        accent: "#34d399", // Verde Neon
        border: "#065f46", // Verde Escuro
        bg: "#09090b", // Preto Zinco
        text: "#34d399", // Texto Verde
        prose: "prose-invert prose-emerald",
      };
    case "pixel_trash": // Art / Vaporwave
      return {
        accent: "#f472b6", // Rosa Neon
        border: "#831843", // Roxo Escuro
        bg: "#1a0b2e", // Roxo Profundo
        text: "#f472b6", // Texto Rosa
        prose: "prose-invert prose-pink",
      };
    default: // Distorção (Padrão)
      return {
        accent: "#ff4d00", // Laranja Safety
        border: "#111111", // Preto Tinta
        bg: "#f4f1ea", // Papel
        text: "#111111", // Texto Preto
        prose: "prose-neutral",
      };
  }
}

const theme = getTheme(post.channel);

const components = {
  block: { blockquote: Blockquote, h2: H2, h3: H3 },
  list: { bullet: BulletList, number: NumberList },
  types: { image: SanityImage },
};
---

<BaseLayout
  title={post.title}
  description={post.excerpt}
  image={post.mainImage ? urlFor(post.mainImage).url() : null}
  accentColor={theme.accent}
  borderColor={theme.border}
  pageBg={theme.bg}
>
  <article
    class="min-h-screen overflow-x-hidden selection:text-white"
    style={`color: ${theme.text}; selection:background-color: ${theme.accent};`}
  >
    {/* HERO SECTION */}
    <header
      class="relative w-full h-[70vh] border-b-4 overflow-hidden group"
      style={`border-color: ${theme.border}`}
    >
      {
        post.mainImage ? (
          <div class="absolute inset-0">
            <img
              src={urlFor(post.mainImage).width(1920).height(1080).url()}
              alt={post.title}
              class="w-full h-full object-cover grayscale contrast-125 brightness-75 transition-all duration-700 group-hover:grayscale-0"
            />
            <div class="absolute inset-0 bg-black/40 mix-blend-multiply" />
          </div>
        ) : (
          <div class="absolute inset-0 bg-ink flex items-center justify-center">
            <span class="font-headline text-paper text-9xl opacity-10">
              NO SIGNAL
            </span>
          </div>
        )
      }

      <div class="absolute bottom-0 left-0 w-full p-6 md:p-12 z-20">
        <div class="max-w-7xl mx-auto">
          <div class="mb-4">
            <ChannelBadge channel={post.channel} />
          </div>
          <h1
            class="text-5xl md:text-8xl lg:text-9xl font-headline uppercase leading-[0.85] text-white drop-shadow-[6px_6px_0px_#000] tracking-tighter"
          >
            {post.title}
          </h1>
        </div>
      </div>
    </header>

    {/* CONTENT GRID */}
    <div
      class="max-w-7xl mx-auto px-4 py-12 md:py-20 grid grid-cols-1 lg:grid-cols-12 gap-12"
    >
      {/* Coluna Texto */}
      <div class="lg:col-span-8">
        <div
          class={`prose prose-xl max-w-none font-mono leading-relaxed ${theme.prose} prose-headings:font-headline hover:prose-a:text-[var(--theme-accent)]`}
        >
          <PortableText value={post.body} components={components} />
        </div>
      </div>

      {/* Sidebar */}
      <aside class="lg:col-span-4 relative">
        <div class="sticky top-28 flex flex-col gap-8">
          <div
            class="backdrop-blur-sm border-4 p-6 shadow-hard bg-white/5"
            style={`border-color: ${theme.border}`}
          >
            <div
              class="border-b-2 pb-4 mb-4"
              style={`border-color: ${theme.border}`}
            >
              <span class="block font-mono text-xs uppercase opacity-70"
                >Publicado em</span
              >
              <span class="font-headline text-2xl">
                {new Date(post.publishedAt).toLocaleDateString("pt-BR")}
              </span>
            </div>

            <div class="flex flex-wrap gap-2">
              {
                post.tags?.map((tag: string) => (
                  <span class="px-2 py-1 bg-black text-white font-mono text-xs uppercase border border-white/20">
                    {tag}
                  </span>
                ))
              }
            </div>
          </div>

          <a
            href="/"
            class="block w-full py-4 text-center font-headline text-2xl uppercase border-4 shadow-hard transition-all hover:-translate-y-1 hover:shadow-hard-lg group relative overflow-hidden"
            style={{
              color: theme.accent,
              borderColor: theme.border,
              backgroundColor: "rgba(0,0,0,0.1)",
            }}
          >
            <div
              class="absolute inset-0 bg-[var(--theme-accent)] translate-y-full group-hover:translate-y-0 transition-transform duration-200 z-0"
            >
            </div>
            <span
              class="relative z-10 group-hover:text-white transition-colors duration-200"
            >
              ← VOLTAR PARA O CAOS
            </span>
          </a>
        </div>
      </aside>
    </div>
  </article>
</BaseLayout>
