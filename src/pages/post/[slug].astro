---
import { PortableText } from "@portabletext/react";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { sanityClient, urlFor } from "../../lib/sanity";

export async function getStaticPaths() {
  const posts = await sanityClient.fetch(`*[_type == "post"]{
    ...,
    slug
  }`);
  return posts.map((post: any) => ({
    params: { slug: post.slug.current },
    props: { post },
  }));
}

interface Props {
  post: any;
}

const { post } = Astro.props;

// Gera URL da imagem OG dinâmica
const ogImage = `/api/og?slug=${post.slug.current}`;

// Prepara description (excerpt ou fallback)
let description = post.excerpt || "Digital Zine & Creative Collective";
if (!post.excerpt && post.body && Array.isArray(post.body)) {
  // Tenta extrair texto do primeiro bloco de texto do PortableText
  const firstBlock = post.body.find(
    (block: any) => block._type === "block" && block.children,
  );
  if (firstBlock && firstBlock.children && firstBlock.children[0]) {
    const text = firstBlock.children[0].text || "";
    description = text.substring(0, 160) + (text.length > 160 ? "..." : "");
  }
}

const source = Astro.url.searchParams.get("source");

import Blockquote from "../../components/Blockquote";
import {
  H2,
  H3,
  BulletList,
  NumberList,
} from "../../components/PortableTextComponents";

// Custom components for PortableText
const components = {
  block: {
    blockquote: Blockquote,
    h2: H2,
    h3: H3,
  },
  list: {
    bullet: BulletList,
    number: NumberList,
  },
};
---

<BaseLayout
  title={post.title}
  description={description}
  image={ogImage}
  type="article"
>
  <article class="min-h-screen bg-paper text-ink overflow-x-hidden">
    {/* 1. HERO SECTION: Full Width, Imagem Gigante, Título Sobreposto */}
    <header
      class="relative w-full h-[80vh] border-b-4 border-ink overflow-hidden"
    >
      {
        post.mainImage ? (
          <div class="absolute inset-0 w-full h-full">
            <img
              src={urlFor(post.mainImage)
                .width(1920)
                .height(1080)
                .fit("crop")
                .url()}
              alt={post.title}
              class="w-full h-full object-cover grayscale contrast-125 brightness-75"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-ink via-transparent to-transparent opacity-80" />
          </div>
        ) : (
          <div class="absolute inset-0 bg-ink flex items-center justify-center">
            <span class="font-headline text-paper text-9xl opacity-10">
              NO SIGNAL
            </span>
          </div>
        )
      }

      <div class="absolute bottom-0 left-0 w-full p-4 md:p-12 z-20">
        <div class="max-w-7xl mx-auto">
          <h1
            class="text-6xl md:text-8xl lg:text-9xl font-headline uppercase leading-[0.85] tracking-tighter text-white drop-shadow-[8px_8px_0px_rgba(0,0,0,1)] break-words"
          >
            {post.title}
          </h1>
        </div>
      </div>
    </header>

    {/* Divisor ASCII */}
    <div class="py-4 px-4 text-center border-b-4 border-ink bg-paper">
      <div
        class="font-mono text-xs md:text-sm tracking-widest text-ink overflow-hidden whitespace-nowrap"
      >
        //----------------//----------------//----------------//----------------//----------------//----------------//
      </div>
    </div>

    {/* 2. LAYOUT DE LEITURA: Grid Editorial */}
    <div class="max-w-7xl mx-auto px-4 py-12 md:py-20">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
        {/* COLUNA ESQUERDA: Conteúdo (8 cols) */}
        <div class="lg:col-span-8">
          <div
            class="prose prose-xl max-w-none font-mono text-ink leading-relaxed prose-p:text-justify prose-a:text-safety-orange prose-a:no-underline hover:prose-a:underline prose-strong:bg-ink prose-strong:text-white prose-strong:px-1"
          >
            <PortableText value={post.body} components={components} />
          </div>
        </div>

        {/* COLUNA DIREITA: Contexto/Sidebar (4 cols) */}
        <aside class="lg:col-span-4 relative">
          <div class="sticky top-8 flex flex-col gap-8">
            {/* Caixa de Metadados */}
            <div class="bg-white border-4 border-ink p-6 shadow-hard">
              <div class="flex flex-col gap-4">
                {/* Data */}
                <div class="border-b-2 border-ink pb-4">
                  <span
                    class="block font-mono text-xs uppercase opacity-60 mb-1"
                    >Publicado em</span
                  >
                  <span class="font-headline text-2xl">
                    {
                      new Date(post.publishedAt).toLocaleDateString("pt-BR", {
                        day: "2-digit",
                        month: "long",
                        year: "numeric",
                      })
                    }
                  </span>
                </div>

                {/* Autor (Placeholder se não vier do Sanity) */}
                <div class="border-b-2 border-ink pb-4">
                  <span
                    class="block font-mono text-xs uppercase opacity-60 mb-1"
                    >Por</span
                  >
                  <span class="font-headline text-xl">MIXTAPE252 CREW</span>
                </div>

                {/* Tags (Placeholder) */}
                <div>
                  <span
                    class="block font-mono text-xs uppercase opacity-60 mb-2"
                    >Tags</span
                  >
                  <div class="flex flex-wrap gap-2">
                    <span
                      class="px-2 py-1 bg-ink text-white font-mono text-xs uppercase"
                      >ZINE</span
                    >
                    <span
                      class="px-2 py-1 bg-ink text-white font-mono text-xs uppercase"
                      >CULTURE</span
                    >
                    <span
                      class="px-2 py-1 bg-ink text-white font-mono text-xs uppercase"
                      >DIGITAL</span
                    >
                  </div>
                </div>
              </div>
            </div>

            {/* Botão Voltar (Navegação Inteligente) */}
            <a
              id="back-link"
              href={source ? `/drop/${source}` : "/"}
              class="block w-full py-4 bg-ink text-white font-headline text-2xl uppercase hover:bg-safety-orange hover:text-ink transition-colors border-4 border-ink text-center shadow-hard transform hover:-rotate-1"
            >
              {source ? "← VOLTAR PARA A EDIÇÃO" : "← VOLTAR PARA O CAOS"}
            </a>
          </div>
        </aside>
      </div>
    </div>

    {/* Divisor ASCII Final */}
    <div class="py-8 px-4 text-center border-t-4 border-ink bg-ink text-paper">
      <div class="font-mono text-sm md:text-base tracking-widest">
        // FIM DA TRANSMISSÃO // FIM DA TRANSMISSÃO // FIM DA TRANSMISSÃO //
      </div>
    </div>
  </article>

  <script>
    // Client-side fallback for static export (Smart Navigation)
    const params = new URLSearchParams(window.location.search);
    const source = params.get("source");
    const backLink = document.getElementById("back-link");

    if (source && backLink) {
      backLink.setAttribute("href", `/drop/${source}`);
      backLink.innerText = "← VOLTAR PARA A EDIÇÃO";
    }
  </script>
</BaseLayout>
